<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>quarks</title>

<style>
  :root{
    --bg: linear-gradient(135deg,#3a1c71,#d76d77,#ffaf7b);
    --chat-width: 100%;
    --header-height: 60px;
    --input-height: 70px;
  }
  html,body{height:100%;margin:0;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Helvetica Neue',Arial,sans-serif;background:var(--bg);-webkit-tap-highlight-color:transparent;-webkit-text-size-adjust:100%}
  *{box-sizing:border-box}
  .wrap{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:10px;box-sizing:border-box;height:100vh;max-height:-webkit-fill-available}
  .card{width:100%;max-width:var(--chat-width);height:100%;border-radius:16px;display:flex;flex-direction:column;overflow:hidden;background:rgba(255,255,255,0.06);backdrop-filter:blur(8px);box-shadow:0 10px 30px rgba(0,0,0,0.35);border:1px solid rgba(255,255,255,0.04);position:relative}
  .header{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;background:rgba(255,255,255,0.03);min-height:var(--header-height);flex-shrink:0}
  .title{font-weight:700;color:#fff;display:flex;gap:10px;align-items:center;font-size:18px}
  .controls{display:flex;gap:8px;align-items:center}
  .btn{background:rgba(255,255,255,0.06);color:#fff;padding:10px 14px;border-radius:12px;border:none;cursor:pointer;font-size:14px;touch-action:manipulation}
  .small{font-size:13px;padding:8px 12px;border-radius:10px}
  #joinArea{display:flex;flex-direction:column;gap:12px;padding:20px 16px;background:rgba(0,0,0,0.1);flex-shrink:0}
  #joinArea input{padding:16px;border-radius:12px;border:none;outline:none;background:rgba(255,255,255,0.03);color:#fff;font-size:16px;width:100%}
  #joinArea input::placeholder{color:rgba(255,255,255,0.6)}
  #joinArea button{background:#ff7aa2;color:#fff;border:none;padding:18px;border-radius:12px;cursor:pointer;font-size:16px;font-weight:600;width:100%;touch-action:manipulation}
  .join-fields{display:flex;flex-direction:column;gap:12px}
  .chatArea{display:flex;flex-direction:column;flex:1;min-height:0;position:relative}
  #messages{flex:1;overflow:auto;padding:16px;display:flex;flex-direction:column;gap:12px;-webkit-overflow-scrolling:touch}
  .bubble{max-width:85%;padding:14px 16px;border-radius:18px;color:#fff;word-wrap:break-word;box-shadow:0 4px 12px rgba(0,0,0,0.15);position:relative;animation:fadeIn .2s ease}
  @keyframes fadeIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
  .meta{font-size:13px;opacity:.85;margin-bottom:6px;font-weight:600}
  .mine{align-self:flex-end;background:linear-gradient(120deg,#4facfe,#00f2fe);border-bottom-right-radius:4px;text-align:right}
  .their{align-self:flex-start;background:linear-gradient(120deg,#ff9a9e,#fecfef);color:#111;border-bottom-left-radius:4px;text-align:left}
  .time{display:block;font-size:11px;opacity:.75;margin-top:6px}
  #typingStatus{padding:8px 16px;font-size:14px;color:rgba(255,255,255,0.85);min-height:20px;font-style:italic;flex-shrink:0}
  .inputBar{display:flex;gap:10px;padding:12px 16px;background:rgba(0,0,0,0.12);align-items:center;min-height:var(--input-height);flex-shrink:0;border-top:1px solid rgba(255,255,255,0.1)}
  #msgBox{flex:1;padding:14px 16px;border-radius:14px;border:none;outline:none;background:rgba(255,255,255,0.04);color:#fff;font-size:16px;min-height:48px;max-height:100px;resize:none;line-height:1.4}
  #msgBox::placeholder{color:rgba(255,255,255,0.6)}
  .iconBtn{background:rgba(255,255,255,0.06);border-radius:12px;padding:12px;border:none;color:#fff;cursor:pointer;touch-action:manipulation;min-width:48px;min-height:48px;display:flex;align-items:center;justify-content:center}
  #sendBtn{background:#ff6a95;color:#fff;padding:14px 20px;border-radius:14px;border:none;cursor:pointer;font-size:16px;font-weight:600;touch-action:manipulation;min-width:70px;min-height:48px}
  #emojiPicker{position:absolute;bottom:var(--input-height);left:10px;right:10px;max-height:240px;background:rgba(255,255,255,0.06);backdrop-filter:blur(8px);padding:12px;border-radius:16px;display:none;overflow:auto;flex-wrap:wrap;gap:8px;z-index:40;border:1px solid rgba(255,255,255,0.1);-webkit-overflow-scrolling:touch;max-width:calc(100% - 20px);box-shadow:0 -5px 20px rgba(0,0,0,0.2)}
  .emoji{font-size:28px;padding:8px;cursor:pointer;display:inline-block;text-align:center;min-width:44px;min-height:44px;border-radius:8px;transition:background .2s}
  .emoji:hover,.emoji:active{background:rgba(255,255,255,0.1)}
  #settingsPanel{position:absolute;top:var(--header-height);right:10px;left:10px;background:rgba(0,0,0,0.8);padding:16px;border-radius:16px;display:none;color:#fff;z-index:40;min-width:auto;max-width:400px;margin:0 auto;border:1px solid rgba(255,255,255,0.1);backdrop-filter:blur(20px)}
  .bgOption{padding:14px;margin:8px 0;border-radius:12px;cursor:pointer;text-align:center;background:rgba(255,255,255,0.1);font-size:15px;transition:background .2s;touch-action:manipulation}
  .bgOption:active{background:rgba(255,255,255,0.2)}
  .muted{opacity:.8;font-size:14px;color:rgba(255,255,255,0.9);text-align:center;padding:10px 0}
  .hidden{display:none}
  @media (max-width:480px){.wrap{padding:0;border-radius:0}.card{border-radius:0;height:100vh;max-height:-webkit-fill-available}.header{padding:12px 16px}.bubble{max-width:90%;padding:12px 14px}#msgBox{font-size:16px;padding:12px 14px}.iconBtn,#sendBtn{padding:10px}#sendBtn{min-width:60px}.title{font-size:16px}}
  #messages::-webkit-scrollbar{width:6px}#messages::-webkit-scrollbar-thumb{background:rgba(255,255,255,0.2);border-radius:3px}
</style>
</head>

<body>
<div class="wrap">
  <div class="card">

    <div class="header">
      <div class="title">Chat</div>
      <div class="controls">
        <div id="roomLabel" class="muted">room: â€”</div>
      </div>
    </div>

    <div id="joinArea">
      <div class="join-fields">
        <input id="roomInput" placeholder="Room name" />
        <input id="nickInput" placeholder="Your name" />
        <button id="joinBtn">Join Chat</button>
      </div>
    </div>

    <div class="chatArea" id="chatArea">
      <div id="emojiPicker"></div>
      <div id="messages"></div>
      <div id="typingStatus"></div>
    </div>

    <div class="inputBar">
      <button id="emojiBtn" class="iconBtn">ðŸ˜Š</button>
      <textarea id="msgBox" placeholder="Type a message..." rows="1"></textarea>
      <button id="sendBtn">Send</button>
    </div>

  </div>
</div>

<script>
/* ===== STATE ===== */
let ws = null;
let room = "";
let nick = "";
let messages = [];

/* ===== DOM ===== */
const joinBtn = document.getElementById("joinBtn");
const roomInput = document.getElementById("roomInput");
const nickInput = document.getElementById("nickInput");
const roomLabel = document.getElementById("roomLabel");
const messagesEl = document.getElementById("messages");
const msgBox = document.getElementById("msgBox");
const sendBtn = document.getElementById("sendBtn");
const emojiBtn = document.getElementById("emojiBtn");
const emojiPicker = document.getElementById("emojiPicker");

function nowTime(){
  const d=new Date();
  let h=d.getHours(), m=String(d.getMinutes()).padStart(2,'0');
  const am=h>=12?'PM':'AM';
  h=h%12||12;
  return `${h}:${m} ${am}`;
}

/* ===== RENDERING ===== */
function renderAll(){
  messagesEl.innerHTML = "";
  messages.forEach(m => renderMsg(m));
  scrollToBottom();
}

function renderMsg(m){
  const div = document.createElement("div");
  div.className = "bubble " + (m.nick === nick ? "mine" : "their");

  const meta = document.createElement("div");
  meta.className = "meta";
  meta.textContent = m.nick;

  const body = document.createElement("div");
  body.textContent = m.text;

  const time = document.createElement("div");
  time.className = "time";
  time.textContent = m.time;

  div.appendChild(meta);
  div.appendChild(body);
  div.appendChild(time);
  messagesEl.appendChild(div);
}

function scrollToBottom(){
  setTimeout(() => messagesEl.scrollTop = messagesEl.scrollHeight, 50);
}

/* ===== WS CONNECT ===== */
function connectWS(){
  ws = new WebSocket("wss://hack.chat/chat-ws");

  ws.onopen = () => {
    ws.send(JSON.stringify({ cmd:"join", channel: room, nick }));
  };

  ws.onmessage = (ev) => {
    let data;
    try { data = JSON.parse(ev.data); } catch(e){ return; }

    // Ignore EVERYTHING except real chat
    if(data.cmd !== "chat") return;
    if(!data.text) return;
    if(!data.nick) return;
    if(data.nick === "server") return;
    if(data.nick === "info") return;

    messages.push({
      nick: data.nick,
      text: data.text,
      time: nowTime()
    });
    renderAll();
  };
}

/* ===== SEND ===== */
function sendMessage(){
  const text = msgBox.value.trim();
  if(!text) return;
  if(!ws || ws.readyState !== 1) return;

  ws.send(JSON.stringify({
    cmd: "chat",
    text
  }));

  msgBox.value = "";
  resizeTextbox();
}

/* ===== EVENTS ===== */
joinBtn.onclick = () => {
  room = roomInput.value.trim();
  nick = nickInput.value.trim();
  if(!room || !nick) return alert("Enter room and name.");

  roomLabel.textContent = "room: " + room;

  // always fresh
  messages = [];
  renderAll();

  document.getElementById("joinArea").style.display = "none";

  connectWS();
  msgBox.focus();
};

sendBtn.onclick = sendMessage;

msgBox.addEventListener("keydown", e => {
  if(e.key === "Enter" && !e.shiftKey){
    e.preventDefault();
    sendMessage();
  }
});

function resizeTextbox(){
  msgBox.style.height = "auto";
  msgBox.style.height = Math.min(msgBox.scrollHeight, 100) + "px";
}
msgBox.addEventListener("input", resizeTextbox);

/* ===== EMOJI ===== */
const EMOJIS = ["ðŸ˜€","ðŸ˜","ðŸ˜‚","ðŸ¤£","ðŸ˜ƒ","ðŸ˜„","ðŸ˜…","ðŸ˜†","ðŸ˜‰","ðŸ˜Š","ðŸ˜","ðŸ˜˜","ðŸ¥°","ðŸ˜Ž","ðŸ™‚","ðŸ¤—","ðŸ¤©","ðŸ¥º","ðŸ˜­","ðŸ˜¡","ðŸ‘","ðŸ™","ðŸ‘","â¤ï¸","ðŸ”¥","âœ¨","ðŸŒ¹"];
EMOJIS.forEach(e => {
  const span = document.createElement("span");
  span.className = "emoji";
  span.textContent = e;
  span.onclick = () => { msgBox.value += e; resizeTextbox(); msgBox.focus(); };
  emojiPicker.appendChild(span);
});

let emojiOpen = false;
emojiBtn.onclick = e => {
  e.stopPropagation();
  emojiOpen = !emojiOpen;
  emojiPicker.style.display = emojiOpen ? "block" : "none";
};

document.addEventListener("click", e => {
  if(emojiOpen && !emojiPicker.contains(e.target) && e.target !== emojiBtn){
    emojiOpen = false; emojiPicker.style.display="none";
  }
});

</script>
</body>
</html>
